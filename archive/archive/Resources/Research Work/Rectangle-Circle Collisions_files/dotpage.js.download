/**
 * @author YellowAfterlife
 * Not everything can be static HTML. For now.
 */
function dotpage_nav() {
	var post = document.querySelector(".post");
	if (!post) return;
	var aside = document.querySelector("#navigation-2");
	var postContent = post.querySelector(".entry-content");
	var headers = post.querySelectorAll("h1,h2,h3");
	//
	var codeblocks = post.querySelectorAll("pre");
	for (var bi = 0; bi < codeblocks.length; bi++) (function(codeblock) {
		if (codeblock.querySelector('.copy-to-clipboard')) return;
		var text = (codeblock.innerText || codeblock.textContent);
		if (text.trim) text = text.trim();
		if (text.split("\n").length < 4) return;
		var copy = document.createElement("a");
		copy.className = "copy-to-clipboard";
		copy.href = "javascript:void(0)";
		copy.title = "Copy to clipboard";
		function showResult(errorText) {
			copy.setAttribute("copy-status", errorText == null
				? "Copied!"
				: ("Failed to copy" + (errorText ? ": " + errorText : "!"))
			);
			setTimeout(function() {
				copy.removeAttribute("copy-status");
			}, 3000);
		}
		copy.onclick = function(_) {
			if (navigator.clipboard && navigator.clipboard.writeText) {
				navigator.clipboard.writeText(text).then(function() {
					showResult();
				}, function(e) {
					showResult(e.message || ("" + e));
				});
			} else {
				var textArea = document.createElement("textarea");
				textArea.value = text;
				textArea.style.position="fixed";
				document.body.appendChild(textArea);
				textArea.focus();
				textArea.select();
				try {
					showResult(document.execCommand('copy') ? null : "");
				} catch (e) {
					showResult(e.message || ("" + e));
				}
				document.body.removeChild(textArea);
			}
		};
		codeblock.insertAdjacentElement('afterbegin', copy);
		codeblock.style.position = "relative";
	})(codeblocks[bi])
	//
	var ul;
	if (aside) {
		ul = aside.querySelector("ul");
	} else ul = document.createElement("ul");
	//
	var navMap = Object.create(null);
	function addNav(s, id, level) {
		var a = document.createElement("a");
		a.appendChild(document.createTextNode(s));
		a.href = "#" + id;
		a.title = s;
		//
		var li = document.createElement("li");
		li.appendChild(a);
		li.classList.add("nav-" + level);
		ul.appendChild(li);
		//
		navMap[id] = li;
	}
	//
	var navObjects = [];
	navObjects.unshift(post.querySelector('.entry-header'));
	addNav("Intro", "content", 2);
	//
	for (var hi = 0; hi < headers.length; hi++) {
		var h = headers[hi];
		if (!h.id) continue;
		navObjects.push(h);
		addNav(h.textContent.trim(), h.id, 0|h.tagName.substring(1));
	}
	if (ul.children.length <= 2) return;
	//
	var endOfPost = document.querySelector('#author-info');
	if (endOfPost) {
		navObjects.push(endOfPost);
		addNav("Outro", "author-info", 2);
	}
	//
	var secondary = document.querySelector("#secondary");
	if (!aside) {
		ul.id = "navigation";
		//
		var asideh = document.createElement("h3");
		asideh.className = "widget-title";
		asideh.appendChild(document.createTextNode("Navigation"));
		//
		var aside = document.createElement("aside");
		aside.className = "widget widget_navigation";
		aside.id = "navigation-2";
		aside.appendChild(asideh);
		aside.appendChild(ul);
		//
		secondary.appendChild(aside);
	}
	//
	var activeEl = null;
	var scrollAtNext = null;
	function getOffsetTop(el) {
		var r = 0;
		while (el) {
			r += el.offsetTop;
			el = el.offsetParent;
		}
		return r;
	}
	function updateScroll() {
		var wndHeight = window.innerHeight;
		var scrollAt = scrollAtNext; scrollAtNext = null;
		var prevAside = aside.previousElementSibling;
		var navTop = prevAside.offsetTop + prevAside.offsetHeight;
		navTop += getOffsetTop(secondary);
		var contentTop = getOffsetTop(postContent.offsetParent);
		var navBot = contentTop + postContent.offsetHeight - wndHeight;
		var rel = (scrollAt - navTop) / (navBot - navTop);
		rel = rel < 0 ? 0 : rel > 1 ? 1 : rel;
		var top = rel * (aside.scrollHeight + 20 - wndHeight);
		if (top > 0) {
			aside.style.top = "calc(0.5em - " + top + "px)";
		} else aside.style.top = "0.5em";
		//
		var hl = 0;
		for (var hi = 0; hi < navObjects.length; hi++) {
			var h = navObjects[hi];
			var ht = contentTop + h.offsetTop;
			if (scrollAt >= ht) hl = hi;
		}
		if (hl >= 0) {
			var h = navObjects[hl];
			var nextActiveEl = navMap[hl > 0 ? h.id : "content"];
			if (activeEl != nextActiveEl) {
				if (activeEl) activeEl.classList.remove("current");
				activeEl = nextActiveEl;
				if (activeEl) activeEl.classList.add("current");
			}
		}
		//
	}
	function scheduleUpdateScroll() {
		if (scrollAtNext === null) {
			scrollAtNext = window.scrollY;
			if (window.requestAnimationFrame) {
				window.requestAnimationFrame(updateScroll);
			} else window.setTimeout(updateScroll, 20);
		}
	}
	document.addEventListener("scroll", scheduleUpdateScroll);
	window.addEventListener("resize", scheduleUpdateScroll);
	scheduleUpdateScroll();
}
try { dotpage_nav(); } catch (e) { console && console.error(e); }

// iOS, y'all:
if (window.ontouchstart !== undefined) try {
	// [https://stackoverflow.com/questions/18047353/fix-css-hover-on-iphone-ipad-ipod]:
	var els = document.querySelectorAll(".rimg-png");
	for (var i = 0; i < els.length; i++) {
		var el = els[i];
		if (!el.getAttribute("onclick")) els[i].setAttribute("onclick", "void(0)");
	}
	// [http://fofwebdesign.co.uk/template/_testing/ios-sticky-hover-fix.htm]:
	document.addEventListener("touchend", function(){});
} catch (e) { console && console.error(e); }